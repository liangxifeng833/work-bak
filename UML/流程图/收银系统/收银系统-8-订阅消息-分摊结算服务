@startuml
title 收款-订阅消息-分摊结算服务-流程图

|消息队列服务|
start
:收款成功\nconsumeId+合同号;

|收款服务|
    :订阅接收到消息队列的\nconsumeId和合同号;
    group 处理当班提交数据
        :查询product_conume\n获取收款员id;
        :查询当班提交表\n计算拆分号和该表主键;
        :更新product_conume表\n拆分号和当班提交表主键;
    end group
    group 蓝景装饰合同处理
        :从redis中查询订单数据;
        if(是否是蓝景装饰合同单?)then(yes)
            :通过蓝景装饰展位号\n查询蓝景装饰商户表主键;
            :修改product_conume表\n关联的商户主键和展位号为蓝景装饰;
        endif
    end group
    group 处理银行卡手续费
        :查询普通支付方式表\n获取银行卡类别;
        :针对银行卡类别计算手续费;
        note right: 注意:借记卡手续费有封顶额\n贷记卡和外卡则没有
        :计算大小额标示;
        :修改银行卡支付方式表\n手续费和大小额等字段;
    end group
    group 处理福卡手续费
        :查询普通支付方式表\n获取福卡手续费率;
        :计算福卡手续费;
        :更新福卡支付方式表\n手续费字段;
    end group
    group 处理第三方卡支付方式手续费
        :查询第三方卡支付方式表\n获取支票手续费率;
        :计算第三方卡手续费;
        :更新第三方卡表手续费字段;
    end group
    group 处理电子券手续费
        :查询合同收券表\n获取券编码;
|电子券服务|
        :通过券使用码查询券主表\n获取批次主键;
        :查询券批次表\n获取<font color=red>卖场分摊比例;
        :计算原卖场分摊额;
|收款服务|
        :修改收券表关联的批次主键;
        if(卖场封顶额活动中\n是否存在该批次\n且在活动期限内?)then(yes)
            :通过合同号查询product_conume\n获取展位号;
|电子券服务|
            :通过展位号和活动表主键\n查询活动商户表\n获取该商户本期活动的封顶额;
|收款服务|
            :通过展位号/活动主键/活动期内\n查询合同收券表已收款卖场总分摊;
            if(原卖场分摊额 + 已收款卖场总分摊 > 商户本期活动的封顶额 )then(yes)
                :达到卖场封顶额;
                if(是否按新分摊计算)then(yes)
                    :按新分摊计算卖场分摊;
                else(noe)
                    :按着老分摊计算卖场分摊;
                endif
            else(no)
                :计算该批次\n占有卖场最高封顶额;
                note right: 占有卖场封顶额最高比例 * 商户本期活动的封顶额
                :通过批次主键/展位号/活动期内\n查询电子券收款记录表\n获取该批次下该商户已用卖场分摊总额;
                if(原卖场分摊额 + 该批次下该商户已用卖场分摊总额 > 占有卖场最高封顶额 ) then(yes)
                    :达到卖场封顶额;
                    if(是否按新分摊计算)then(yes)
                        :按新分摊计算;
                    else(noe)
                        :按着老分摊计算;
                    endif
                else(no)
                        :按着老分摊计算;
                endif
            endif
            :修改合同收券表\n卖场分摊比例\n卖场分摊金额\n封顶额活动表主键\n是否使用新分摊等字段;
        else(no)
            :按着老分摊比例计算卖场分摊;
            :修改合同收券表\n卖场分摊比例\n卖场分摊金额\n是否使用新分摊等字段;
        endif
        :修改payform_list表\npayform_trade_fee字段=商户分摊;
        :新增商户返款关系表数据;
    end group
end
@enduml
