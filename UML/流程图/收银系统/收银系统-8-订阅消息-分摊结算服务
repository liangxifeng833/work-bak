@startuml
title 收款-订阅消息-分摊结算服务-流程图

|消息队列服务|
start
:收款成功\nconsumeId+合同号;

|收款服务|
    :订阅接收到消息队列的\nconsumeId和合同号;
    group 处理当班提交数据
        :查询product_conume\n获取收款员id;
        :查询当班提交表\n计算拆分号和该表主键;
        :更新product_conume表\n拆分号和当班提交表主键;
    end group
    group 处理银行卡手续费
        :查询普通支付方式表\n获取银行卡类别;
        :针对银行卡类别计算手续费;
        note right: 注意:借记卡手续费有封顶额\n贷记卡和外卡则没有
        :计算大小额标示;
        :修改银行卡支付方式表\n手续费和大小额等字段;
    end group
    group 处理福卡手续费
        :查询普通支付方式表\n获取福卡手续费率;
        :计算福卡手续费;
        :更新福卡支付方式表\n手续费字段;
    end group
    group 处理第三方卡支付方式手续费
        :查询第三方卡支付方式表\n获取支票手续费率;
        :计算第三方卡手续费;
        :更新第三方卡表手续费字段;
    end group
    group 处理电子券手续费
        :查询合同收券表\n获取券编码;
|电子券服务|
        :通过券编码查询券批次表\n获取商户分摊额;
|收款服务|
        :修改合同收券表\n商户分摊字段;
        :修改payform_list表\npayform_trade_fee字段=商户分摊;
    end group
end
@enduml
